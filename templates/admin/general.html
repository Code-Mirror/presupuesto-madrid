{% extends 'admin.html' %}
{% block content %}

{% load static %}

<section class="admin" role="region">

  <div class="admin-header section-header">
    <div class="container">
      <h2 class="page-title">{{ _('Presupuesto general') }}</h2>
    </div>
  </div>

  <div class="admin-content">
    <div class="container">
      <div class="data-panel">

        <div class="panel">
          <div class="panel-content">
            <h3>1. Descargar datos</h3>
            <p>El primer paso es descargar los ficheros de datos del portal de Datos Abiertos de Madrid. Para ello, introduce la URL de la página con la información del presupuesto a cargar (por defecto estamos utilizando la del <a href="https://datos.madrid.es/portal/site/egob/menuitem.c05c1f754a33a9fbe4b2e4b284f1a5a0/?vgnextoid=1f95efc7b8e08610VgnVCM1000001d4a900aRCRD&vgnextchannel=374512b9ace9f310VgnVCM100000171f5a0aRCRD&vgnextfmt=default">ejercicio en curso</a>), y especifica a qué año corresponden los datos en caso de querer actualizar los <a href="https://datos.madrid.es/sites/v/index.jsp?vgnextoid=14f285e4b1204410VgnVCM1000000b205a0aRCRD&vgnextchannel=20d612b9ace9f310VgnVCM100000171f5a0aRCRD">datos históricos</a> (ya que el Portal actualmente enlaza los datos históricos desde la misma página). Al pulsar el botón 'Descargar', los datos se bajarán del Portal en unos segundos y se guardarán en el servidor, listos para el siguiente paso.</p>

            <form id="data-download">
              <div class="form-group">
                <label for="source-path">{{ _('Fuente de datos') }}</label>
                <input type="text" id="source-path" class="form-control" name="source-path" placeholder="{{ _('Escribe aquí la dirección de la página') }}" value="https://datos.madrid.es/portal/site/egob/menuitem.c05c1f754a33a9fbe4b2e4b284f1a5a0/?vgnextoid=1f95efc7b8e08610VgnVCM1000001d4a900aRCRD&vgnextchannel=374512b9ace9f310VgnVCM100000171f5a0aRCRD&vgnextfmt=default">
              </div>
              <div class="form-group">
                <label for="year">{{ _('Selecciona año') }}</label>
                <select id="year" class="form-control" name="month">
                  <option value="2011">2011</option>
                  <option value="2012">2012</option>
                  <option value="2013">2013</option>
                  <option value="2014">2014</option>
                  <option value="2015">2015</option>
                  <option value="2016">2016</option>
                  <option value="2017">2017</option>
                  <option value="2018">2018</option>
                  <option value="2019" selected>2019</option>
                </select>
              </div>
              <button type="submit" class="btn btn-default btn-primary" >{{ _('Descargar') }}</button>
            </form>
            <div id="data-download-output" class="data-output">
              <div class="loading"><img src="/static/assets/loader.png"> Descargando datos</div>
              <div class="output"></div>
            </div>
          </div>
        </div>

        <div class="panel">
          <div class="panel-content">
            <h3>2. Revisar datos</h3>
            <p>Una vez descargados, podemos revisar los datos para comprobar que las eliminaciones (flujos internos entre organismos del Ayuntamiento de Madrid) coinciden con lo esperado.</p>
            <form class="form-inline" id="data-review" action="" method="get">
              <button type="submit" class="btn btn-default btn-primary" >{{ _('Revisar') }}</button>
            </form>
            <div id="data-review-output" class="data-output">
              <div class="loading"><img src="/static/assets/loader.png"> Revisando datos</div>
              <div class="output"></div>
            </div>
          </div>
        </div>

        <div class="panel">
          <div class="panel-content">
            <h3>3. Cargar datos</h3>
            <p>Finalmente, podemos cargar los datos descargados en la base de datos, haciéndolos visibles al exterior, tanto en español como en inglés. El proceso de carga incluye datos de ingresos, de gastos y de inversiones, y tarda unos 4-5 minutos.</p>
            <form class="form-inline" id="data-load">
              <button type="submit" class="btn btn-default btn-primary" >{{ _('Cargar') }}</button>
            </form>
            <div id="data-load-output" class="data-output">
              <div class="loading"><img src="/static/assets/loader.png"> Cargando datos</div>
              <div class="output"></div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

</section>

<script>
  $('#data-download').submit(function(e) {
    e.preventDefault();
    disableButtons();
    $("#data-download-output").show().find('.content').html('');
    $.ajax({
      url: "{{ url('presupuesto-madrid.views.admin_download') }}",
      data: {
        source_path:  $('#source-path').val(),
        month:  $('#month').val(),
      },
      contentType:    'application/json; charset=utf-8',
      success:        onCommandSuccess,
      error:          onCommandError,
    });
  });

  $('#data-review').submit(function(e) {
    e.preventDefault();
    disableButtons();
    $("#data-review-output").show().find('.content').html('');
    $.ajax({
      url: "{{ url('presupuesto-madrid.views.admin_review') }}",
      contentType:    'application/json; charset=utf-8',
      success:        onCommandSuccess,
      error:          onCommandError,
    });
  });

  $('#data-load').submit(function(e) {
    e.preventDefault();
    disableButtons();
    $("#data-load-output").show().find('.content').html('');
    $.ajax({
      url: "{{ url('presupuesto-madrid.views.admin_load') }}",
      contentType:    'application/json; charset=utf-8',
      success:        onCommandSuccess,
      error:          onCommandError,
    });
  });

  function onCommandSuccess(response) {
    if (response.download_output != '') {
      $("#data-download-output").find('.loading').hide();
      $("#data-download-output").find('.output').html(response.download_output);
    }
    if (response.review_output != '') {
      $("#data-review-output").find('.loading').hide();
      $("#data-review-output").find('.output').html(response.review_output);
    }
    if (response.load_output != '') {
      $("#data-load-output").find('.loading').hide();
      $("#data-load-output").find('.output').html(response.load_output);
    }
    enableButtons();
  }

  function onCommandError(response) {
    enableButtons();
  }

  function disableButtons() {
    $('#data-download button[type="submit"]').attr('disabled', true).children('.glyphicon').removeClass('hide');
  }

  function enableButtons() {
    $('#data-download button[type="submit"]').attr('disabled', false).children('.glyphicon').addClass('hide');
  }
</script>

{% endblock %}
